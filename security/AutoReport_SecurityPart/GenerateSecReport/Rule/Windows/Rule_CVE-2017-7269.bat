@echo off
SetLocal EnableDelayedExpansion
rem rule CVE-2017-7269

rem WebDAV service in Internet Information Services (IIS) 6.0 (RCE)

rem Buffer overflow in the ScStoragePathFromUrl function in the WebDAV service in Internet Information Services (IIS) 6.0 in Microsoft Windows Server 2003 R2
rem  allows remote attackers to execute arbitrary code via a long header beginning with "If: <http://" in a PROPFIND request, as exploited in the wild in July or August 2016. 

set Affected=1
set NotAffected=0

set InsInfoFile=%~1

rem Affected If kernel version NT5.2 IIS enable WebDAV

call GetKeyValue2.bat "%InsInfoFile%" "SYSTEM"
set SYSTEM=%Value%

echo !SYSTEM!|find /i "Server 2003 R2">nul
if errorlevel 1 (
	echo !SYSTEM!|find /i "Server 2003">nul
	if NOT errorlevel 1 (
		set kernel=NT5.2
	)
) else set kernel=NT5.2

set Return=%NotAffected%

if "!kernel!"=="NT5.2" (
	rem Skip for now
	if "IIS_WebDAV"=="Enabled" set Return=%Affected%
)

exit/b %Return%
